<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<style>

			iframe {
				opacity: 0;
				transition: opacity 5s;
			}

			.fadeIn {
				opacity: 1;
			}
			.fadeOut {
				opacity: 0;
			}
			.hidden {
				display: none;
			}

			body {
				padding: 0;
				margin: 0;
				background-color: black;
			}
		</style>
	</head>
	<body><!-- 
		<iframe width="100%" height="100%" src="https://www.youtube.com/embed/ffxKSjUwKdU?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
		<iframe width="100%" height="100%" src="https://www.youtube.com/embed/tGRzz0oqgUE?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
		<iframe width="100%" height="100%" src="https://www.youtube.com/embed/OQitfe8u7i4?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe> -->
		<script type="text/javascript">
			/*
			crossfadeTime = 5000;

			function fadeIn(iframe) {
				iframe.addClass('fadeIn');
			}
			function fadeOut(iframe) {
				iframe.addClass('fadeOut');
			}

			function stopSong(iframe) {
				src = iframe.attr('src');
				iframe.attr('src', src.split('&autoplay')[0]);
			}

			function startSong(iframe) {
				src = iframe.attr('src');
				iframe.attr('src', src + "&autoplay=1");
			}

			function fadeBetweenIframes(iframe1, iframe2) {
				loadDelay = 3000; // Autoplaying a video will load it, doesn't happen instantly
				// We want to start the new song so it will load, but delay the fade in until it's loaded enough
				startSong(iframe2);

				setTimeout(function() {
					fadeOut(iframe1);
				}, loadDelay);

				setTimeout(function() {
					stopSong(iframe1);
				}, loadDelay + crossfadeTime);

				setTimeout(function() {
					fadeIn(iframe2);
				}, loadDelay);
			}

			iframes = $('iframe');
			currentSong = 0;
			iframes.each(function() {
				$(this).css('position', 'absolute');
				$(this).css('left', 0);
			});
			startSong($(iframes[currentSong]));

			setTimeout(function() {
				fadeBetweenIframes($(iframes[currentSong]), $(iframes[currentSong + 1]));
			}, 20000);

			setTimeout(function() {
				fadeBetweenIframes($(iframes[currentSong + 1]), $(iframes[currentSong + 2]));
			}, 20000 * 2 + crossfadeTime);

			//$(iframes[currentSong]).css('opacity', 1);
			fadeIn($(iframes[currentSong]));*/
		</script>

		<!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <div id="player"></div>

    <script>

    	// When debug is on, the videos appear stacked instead of on top of eachother, for easier viewing of the transitions
    	DEBUG = false;

    	songs = [{
    		id: 'ffxKSjUwKdU',
    		startTime: 0,
    		endTime: 15,
    	},
    	{
    		id: 'OQitfe8u7i4',
    		startTime: 60,
    		endTime: 80,
    	},
    	{
    		id: 'cggNqDAtJYU',
    		startTime: 450,
    		endTime: 500,
    	},
    	{
    		id: 'tGRzz0oqgUE',
    		startTime: 60,
    		endTime: 80,
    	},
    	{
    		id: 'kHLHSlExFis',
    		startTime: 60,
    		endTime: 80,
    	},
    	{
    		id: 'xTlNMmZKwpA',
    		startTime: 60,
    		endTime: 80,
    	}
    	];
    	fadeOutDuration = 5;
    	currentSong = 0;
    	videoPlayers = [];
    	playerStyle = (DEBUG) ? '' : `style="position: absolute;left:0;"`;

    	// create the divs for the iframes
    	for(j = 0; j < songs.length; j++) {
    		$('body').append(`<div id="player${j}" ${playerStyle}></div>`);
    	}

      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      // var player;
      function onYouTubeIframeAPIReady() {
      	for(i = 0; i < songs.length; i++) {
      		events = {}
      		if (i == 0) {
      			events = {
      				'onReady': function(event) {
      					startVideo(event.target);
      					fadeIn(event.target);
      				}
      			}
      		}

      		newPlayer = new YT.Player(`player${i}`, {
	          height: '100%',
	          width: '100%',
	          videoId: songs[i].id,
	          events
	        });
	        videoPlayers.push(newPlayer);
      	}

	      // Main loop for switching songs
	      setInterval(checkPlayerStatus, 1000);
      }

      function checkPlayerStatus() {
      	currentPlayer = videoPlayers[currentSong];
      	if (!currentPlayer) {
      		return;
      	}

      	songDuration = currentPlayer.getDuration();
      	currentTime = currentPlayer.getCurrentTime();

      	endOfSong = songDuration - fadeOutDuration;
      	if (songs[currentSong].endTime) {
      		endOfSong = songs[currentSong].endTime - fadeOutDuration;
      	}

      	console.log('current time ' + currentTime);
      	console.log('ending at ' + endOfSong);

      	if (currentTime >= endOfSong) {
      		fadeBetweenPlayers(currentPlayer, videoPlayers[currentSong + 1]);
      	}
      }

			function fadeBetweenPlayers(player1, player2) {
				loadDelay = 3000; // Autoplaying a video will load it, doesn't happen instantly
				// We want to start the new song so it will load, but delay the fade in until it's loaded enough
				currentSong++;
				startVideo(player2, songs[currentSong].startTime);
				$(player1.getIframe()).css('z-index', 0);
				$(player2.getIframe()).css('z-index', 100);

				fadeOut(player1);

				setTimeout(function() {
					stopVideo(player1);
				}, fadeOutDuration * 1000);

				setTimeout(function() {
					fadeIn(player2);
				}, loadDelay);
			}

      function fadeOutAudio(player) {
      	fadeoutInterval = setInterval(function() {
      		currentVolume = player.getVolume();
      		if (!player || currentVolume <= 0) {
      			clearInterval(fadeoutInterval);
      		} else {
      			player.setVolume(currentVolume - 4);
      		}
      	}, 100);
      }

      function fadeInAudio(player) {
      	fadeinInterval = setInterval(function() {
      		currentVolume = player.getVolume();
      		if (!player || currentVolume >= 100) {
      			clearInterval(fadeinInterval);
      		} else {
      			player.setVolume(currentVolume + 4);
      		}
      	}, 100);
      }

      function stopVideo(player) {
        player.stopVideo();
      }

      function startVideo(player, seconds) {
      	if (seconds) {
      		player.seekTo(seconds);
      	} else {
      		player.playVideo();
      	}

      	// Set starting video audio volume to 0
      	player.setVolume(0);
      }

			function fadeIn(player) {
				$(player.getIframe()).addClass('fadeIn');
				fadeInAudio(player);
			}
			function fadeOut(player) {
				$(player.getIframe()).addClass('fadeOut');
				fadeOutAudio(player);
			}
    </script>
	</body>
</html>